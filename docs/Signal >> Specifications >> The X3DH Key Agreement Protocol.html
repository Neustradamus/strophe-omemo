<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content=""><meta name="author" content=""><meta name="twitter:card" content="app"><meta name="twitter:site" content="@whispersystems"><meta name="twitter:app:name:iphone" content="Signal"><meta name="twitter:app:id:iphone" content="874139669"><meta name="twitter:app:name:googleplay" content="TextSecure"><meta name="twitter:app:id:googleplay" content="org.thoughtcrime.securesms"><title>Signal &gt;&gt; Specifications &gt;&gt; The X3DH Key Agreement Protocol</title><link rel="apple-touch-icon" sizes="57x57" href="https://signal.org/assets/favicon/apple-icon-57x57-00feed768a563157c8fc6fed4e3fa0b805711f97d8d6a8f0f92c4d969c8b7c81.png"><link rel="apple-touch-icon" sizes="60x60" href="https://signal.org/assets/favicon/apple-icon-60x60-e5fe791fca3521d5845d02f310113cce415c79700d394d9074a973d885001f6c.png"><link rel="apple-touch-icon" sizes="72x72" href="https://signal.org/assets/favicon/apple-icon-72x72-3d5078eb670baea079173c32f067978a706996945f03ef3b5383eb44fc4d611f.png"><link rel="apple-touch-icon" sizes="76x76" href="https://signal.org/assets/favicon/apple-icon-76x76-0dbbb0f8b44f2d80329100aa9f0dba07297fedd878cd1158fa59a9c01167c77b.png"><link rel="apple-touch-icon" sizes="114x114" href="https://signal.org/assets/favicon/apple-icon-114x114-25b9c9173bfa29b166a619da2ca59f86e48d1eab1d3370f1264b822421d120fb.png"><link rel="apple-touch-icon" sizes="120x120" href="https://signal.org/assets/favicon/apple-icon-120x120-7f74e6f2d3cab9b3c160ff0f27261f83f52c9df6067100c350c561b4f0377fda.png"><link rel="apple-touch-icon" sizes="144x144" href="https://signal.org/assets/favicon/apple-icon-144x144-5dc9b2a79b41714f67a10dd60ab3b2238358c9cb508e35c0133ca8dc4df7e086.png"><link rel="apple-touch-icon" sizes="152x152" href="https://signal.org/assets/favicon/apple-icon-152x152-dc7b16329390721a64801665848b451fb865633efdfe033ffc440837a0369882.png"><link rel="apple-touch-icon" sizes="180x180" href="https://signal.org/assets/favicon/apple-icon-180x180-795ae24a0e9174cba80947c2d2c9087e0dffbb89a7001e14434223d36fa98933.png"><link rel="icon" type="image/png" sizes="192x192" href="https://signal.org/assets/favicon/android-icon-192x192-1d508a6d63f514f7199ce3e677c55dbd30f30809961c645ac526a278a9c9449d.png"><link rel="icon" type="image/png" sizes="32x32" href="https://signal.org/assets/favicon/favicon-32x32-5bab16438a8e298a1731e3c393f1f61d7e2ed1cb9de3f8a6b0e49c4bd7c776e6.png"><link rel="icon" type="image/png" sizes="96x96" href="https://signal.org/assets/favicon/favicon-96x96-e6590f79393a4c2bbd5e8dcc27a42aa2e58f1e2f35a7e22a071b8cd023fa4f3f.png"><link rel="icon" type="image/png" sizes="16x16" href="https://signal.org/assets/favicon/favicon-16x16-04440ded6f2156fe146523a0cbfa066bfa08bdf557f2f49e3689eb79794f3bd6.png"><link rel="manifest" href="https://signal.org/assets/favicon/manifest-27eca3e8297eb7ff340deb3849b210185a459b3845456aa4d0036f6d966b3518.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/favicon/ms-icon-144x144-5dc9b2a79b41714f67a10dd60ab3b2238358c9cb508e35c0133ca8dc4df7e086.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/bootstrap.css"><link rel="stylesheet" href="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/bootstrap-theme.css"><link type="text/css" rel="stylesheet" href="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/theme-11b39073e609de4fa81bd8592e38802abfc10fe6114f2b80ee6882.css"><link type="text/css" rel="stylesheet" href="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/syntax-881bc4f9ec9a8040c6348007919d38b71a25b475c10aba237498d.css"><link href="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/font-awesome.css" rel="stylesheet"><link href="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/css.css" rel="stylesheet" type="text/css"><script type="text/javascript" async="" src="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/js"></script></head><body id="page-top" class="index"><nav class="navbar navbar-default navbar-fixed-top navbar-shrink "><div class="container"><div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <img src="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/logo-70556391d9e0f1642cf4ac8bafb3911db909aa3ca820e6d2dc412fa.png"> <a class="navbar-brand page-scroll" href="https://signal.org/#page-top">Signal</a></div><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><ul class="nav navbar-nav navbar-right"><li class="hidden"> <a href="#page-top"></a></li><li> <a href="http://support.signal.org/">Support</a></li><li> <a class="page-scroll" href="https://signal.org/blog/">Blog</a></li><li> <a class="page-scroll" href="https://signal.org/docs/">Developers</a></li><li> <a class="page-scroll" href="https://signal.org/workworkwork/">Jobs</a></li><li> <a href="https://twitter.com/whispersystems"><i class="fa fa-twitter"></i></a></li></ul></div></div></nav><section id="specification"><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <img class="author img-responsive img-circle" src="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/spaceship-e722e5c700acd0e0ac8b003fb8269174a00e6190021f47ea23.png"><h1 class="post-title"> The X3DH Key Agreement Protocol</h1><h3 class="post-subtitle"><p>Revision 1, 2016-11-04 [<a href="https://signal.org/docs/specifications/x3dh/x3dh.pdf">PDF</a>]</p><p>Moxie Marlinspike, Trevor Perrin (editor)</p></h3></div></div><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div id="TOC"><h2 class="toc">Table of Contents</h2><ul><li><a href="#introduction">1. Introduction</a></li><li><a href="#preliminaries">2. Preliminaries</a><ul><li><a href="#x3dh-parameters">2.1. X3DH parameters</a></li><li><a href="#cryptographic-notation">2.2. Cryptographic notation</a></li><li><a href="#roles">2.3. Roles</a></li><li><a href="#keys">2.4. Keys</a></li></ul></li><li><a href="#the-x3dh-protocol">3. The X3DH protocol</a><ul><li><a href="#overview">3.1. Overview</a></li><li><a href="#publishing-keys">3.2. Publishing keys</a></li><li><a href="#sending-the-initial-message">3.3. Sending the initial message</a></li><li><a href="#receiving-the-initial-message">3.4. Receiving the initial message</a></li></ul></li><li><a href="#security-considerations">4. Security considerations</a><ul><li><a href="#authentication">4.1. Authentication</a></li><li><a href="#protocol-replay">4.2. Protocol replay</a></li><li><a href="#replay-and-key-reuse">4.3. Replay and key reuse</a></li><li><a href="#deniability">4.4. Deniability</a></li><li><a href="#signatures">4.5. Signatures</a></li><li><a href="#key-compromise">4.6. Key compromise</a></li><li><a href="#server-trust">4.7. Server trust</a></li><li><a href="#identity-binding">4.8. Identity binding</a></li></ul></li><li><a href="#ipr">5. IPR</a></li><li><a href="#acknowledgements">6. Acknowledgements</a></li><li><a href="#references">7. References</a></li></ul></div><p></p><h1 id="introduction">1. Introduction</h1><p>This
 document describes the "X3DH" (or "Extended Triple Diffie-Hellman") key
 agreement protocol. X3DH establishes a shared secret key between two 
parties who mutually authenticate each other based on public keys. X3DH 
provides forward secrecy and cryptographic deniability.</p><p>X3DH is 
designed for asynchronous settings where one user ("Bob") is offline but
 has published some information to a server. Another user ("Alice") 
wants to use that information to send encrypted data to Bob, and also 
establish a shared secret key for future communication.</p><h1 id="preliminaries">2. Preliminaries</h1><h2 id="x3dh-parameters">2.1. X3DH parameters</h2><p>An application using X3DH must decide on several parameters:</p><table style="width:92%;"><colgroup><col width="12%"><col width="79%"></colgroup><thead><tr class="header"><th align="left">Name</th><th align="left">Definition</th></tr></thead><tbody><tr class="odd"><td align="left"><em>curve</em></td><td align="left">X25519 or X448</td></tr><tr class="even"><td align="left"><em>hash</em></td><td align="left">A 256 or 512-bit hash function (e.g. SHA-256 or SHA-512)</td></tr><tr class="odd"><td align="left"><em>info</em></td><td align="left">An ASCII string identifying the application</td></tr></tbody></table><p>For example, an application could choose <em>curve</em> as X25519, <em>hash</em> as SHA-512, and <em>info</em> as "MyProtocol".</p><p>An application must additionally define an encoding function <em>Encode(PK)</em> to encode an X25519 or X448 public key <em>PK</em>
 into a byte sequence. The recommended encoding consists of some 
single-byte constant to represent the type of curve, followed by 
little-endian encoding of the u-coordinate as specified in <span class="citation">[<a href="#ref-rfc7748">1</a>]</span>.</p><h2 id="cryptographic-notation">2.2. Cryptographic notation</h2><p>X3DH will use the following notation:</p><ul><li><p>The concatenation of byte sequences <strong><em>X</em></strong> and <strong><em>Y</em></strong> is <strong><em>X</em></strong> || <strong><em>Y</em></strong>.</p></li><li><p><strong><em>DH(PK1, PK2)</em></strong>
 represents a byte sequence which is the shared secret output from an 
Elliptic Curve Diffie-Hellman function involving the key pairs 
represented by public keys <em>PK1</em> and <em>PK2</em>. The Elliptic Curve Diffie-Hellman function will be either the X25519 or X448 function from <span class="citation">[<a href="#ref-rfc7748">1</a>]</span>, depending on the <em>curve</em> parameter.</p></li><li><p><strong><em>Sig(PK, M)</em></strong> represents a byte sequence that is an XEdDSA signature on the byte sequence <em>M</em> and verifies with public key <em>PK</em>, and which was created by signing <em>M</em> with <em>PK</em>'s corresponding private key. The signing and verification functions for XEdDSA are specified in<span class="citation">[<a href="#ref-xeddsa">2</a>]</span>.</p></li><li><strong><em>KDF(KM)</em></strong> represents 32 bytes of output from the HKDF algorithm <span class="citation">[<a href="#ref-rfc5869">3</a>]</span> with inputs:<ul><li><em>HKDF input key material</em> = <em>F</em> || <em>KM</em>, where <em>KM</em> is an input byte sequence containing secret key material, and <em>F</em> is a byte sequence containing 32 0xFF bytes if <em>curve</em> is X25519, and 57 0xFF bytes if <em>curve</em> is X448. <em>F</em> is used for cryptographic domain separation with XEdDSA <span class="citation">[<a href="#ref-xeddsa">2</a>]</span>.</li><li><em>HKDF salt</em> = A zero-filled byte sequence with length equal to the <em>hash</em> output length.</li><li><em>HKDF info</em> = The <em>info</em> parameter from <a href="#x3dh-parameters">Section 2.1</a>.</li></ul></li></ul><h2 id="roles">2.3. Roles</h2><p>The X3DH protocol involves three parties: <strong>Alice</strong>, <strong>Bob</strong>, and a <strong>server</strong>.</p><ul><li><p><strong>Alice</strong>
 wants to send Bob some initial data using encryption, and also 
establish a shared secret key which may be used for bidirectional 
communication.</p></li><li><p><strong>Bob</strong> wants to allow 
parties like Alice to establish a shared key with him and send encrypted
 data. However, Bob might be offline when Alice attempts to do this. To 
enable this, Bob has a relationship with some server.</p></li><li><p>The <strong>server</strong>
 can store messages from Alice to Bob which Bob can later retrieve. The 
server also lets Bob publish some data which the server will provide to 
parties like Alice. The amount of trust placed in the server is 
discussed in <a href="#server-trust">Section 4.7</a>.</p></li></ul><p>In
 some systems the server role might be divided amongst multiple 
entities, but for simplicity we assume a single server that provides the
 above functions for Alice and Bob.</p><p></p><h2 id="keys">2.4. Keys</h2><p>X3DH uses the following elliptic curve public keys:</p><table><colgroup><col width="14%"><col width="85%"></colgroup><thead><tr class="header"><th align="left">Name</th><th align="left">Definition</th></tr></thead><tbody><tr class="odd"><td align="left"><em>IK<sub>A</sub></em></td><td align="left">Alice's identity key</td></tr><tr class="even"><td align="left"><em>EK<sub>A</sub></em></td><td align="left">Alice's ephemeral key</td></tr><tr class="odd"><td align="left"><em>IK<sub>B</sub></em></td><td align="left">Bob's identity key</td></tr><tr class="even"><td align="left"><em>SPK<sub>B</sub></em></td><td align="left">Bob's signed prekey</td></tr><tr class="odd"><td align="left"><em>OPK<sub>B</sub></em></td><td align="left">Bob's one-time prekey</td></tr></tbody></table><p>All public keys have a corresponding private key, but to simplify description we will focus on the public keys.</p><p>The
 public keys used within an X3DH protocol run must either all be in 
X25519 form, or they must all be in X448 form, depending on the <em>curve</em> parameter <span class="citation">[<a href="#ref-rfc7748">1</a>]</span>.</p><p>Each party has a long-term identity public key (<em>IK<sub>A</sub></em> for Alice, <em>IK<sub>B</sub></em> for Bob).</p><p>Bob also has a signed prekey <em>SPK<sub>B</sub></em>, which he will change periodically, and a set of one-time prekeys <em>OPK<sub>B</sub></em>,
 which are each used in a single X3DH protocol run. ("Prekeys" are so 
named because they are essentially protocol messages which Bob publishes
 to the server <em>prior</em> to Alice beginning the protocol run).</p><p>During each protocol run, Alice generates a new ephemeral key pair with public key <em>EK<sub>A</sub></em>.</p><p>After a successful protocol run Alice and Bob will share a 32-byte secret key <em>SK</em>. This key may be used within some post-X3DH secure communication protocol, subject to the security considerations in <a href="#security-considerations">Section 4</a>.</p><h1 id="the-x3dh-protocol">3. The X3DH protocol</h1><h2 id="overview">3.1. Overview</h2><p>X3DH has three phases:</p><ol style="list-style-type: decimal"><li><p>Bob publishes his identity key and prekeys to a server.</p></li><li><p>Alice fetches a "prekey bundle" from the server, and uses it to send an initial message to Bob.</p></li><li><p>Bob receives and processes Alice's initial message.</p></li></ol><p>The following sections explain these phases.</p><h2 id="publishing-keys">3.2. Publishing keys</h2><p>Bob publishes a set of elliptic curve public keys to the server, containing:</p><ul><li>Bob's identity key <em>IK<sub>B</sub></em></li><li>Bob's signed prekey <em>SPK<sub>B</sub></em></li><li>Bob's prekey signature <em>Sig(IK<sub>B</sub>, Encode(SPK<sub>B</sub>))</em></li><li>A set of Bob's one-time prekeys (<em>OPK<sub>B</sub><sup>1</sup></em>, <em>OPK<sub>B</sub><sup>2</sup></em>, <em>OPK<sub>B</sub><sup>3</sup></em>, ...)</li></ul><p>Bob
 only needs to upload his identity key to the server once. However, Bob 
may upload new one-time prekeys at other times (e.g. when the server 
informs Bob that the server's store of one-time prekeys is getting low).</p><p>Bob
 will also upload a new signed prekey and prekey signature at some 
interval (e.g. once a week, or once a month). The new signed prekey and 
prekey signature will replace the previous values.</p><p>After uploading
 a new signed prekey, Bob may keep the private key corresponding to the 
previous signed prekey around for some period of time, to handle 
messages using it that have been delayed in transit. Eventually, Bob 
should delete this private key for forward secrecy (one-time prekey 
private keys will be deleted as Bob receives messages using them; see <a href="#receiving-the-initial-message">Section 3.4</a>).</p><h2 id="sending-the-initial-message">3.3. Sending the initial message</h2><p>To
 perform an X3DH key agreement with Bob, Alice contacts the server and 
fetches a "prekey bundle" containing the following values:</p><ul><li>Bob's identity key <em>IK<sub>B</sub></em></li><li>Bob's signed prekey <em>SPK<sub>B</sub></em></li><li>Bob's prekey signature <em>Sig(IK<sub>B</sub>, Encode(SPK<sub>B</sub>))</em></li><li>(Optionally) Bob's one-time prekey <em>OPK<sub>B</sub></em></li></ul><p>The
 server should provide one of Bob's one-time prekeys if one exists, and 
then delete it. If all of Bob's one-time prekeys on the server have been
 deleted, the bundle will not contain a one-time prekey.</p><p>Alice 
verifies the prekey signature and aborts the protocol if verification 
fails. Alice then generates an ephemeral key pair with public key <em>EK<sub>A</sub></em>.</p><p>If the bundle does not contain a one-time prekey, she calculates:</p><div class="code"><p>&nbsp;&nbsp;&nbsp;&nbsp;DH1 = DH(IK<sub>A</sub>, SPK<sub>B</sub>)<br> &nbsp;&nbsp;&nbsp;&nbsp;DH2 = DH(EK<sub>A</sub>, IK<sub>B</sub>)<br> &nbsp;&nbsp;&nbsp;&nbsp;DH3 = DH(EK<sub>A</sub>, SPK<sub>B</sub>)<br> &nbsp;&nbsp;&nbsp;&nbsp;SK = KDF(DH1 || DH2 || DH3)</p></div><p>If the bundle <em>does</em> contain a one-time prekey, the calculation is modified to include an additional <em>DH</em>:</p><div class="code"><p>&nbsp;&nbsp;&nbsp;&nbsp;DH4 = DH(EK<sub>A</sub>, OPK<sub>B</sub>)<br> &nbsp;&nbsp;&nbsp;&nbsp;SK = KDF(DH1 || DH2 || DH3 || DH4)</p></div><p>The following diagram shows the <em>DH</em> calculations between keys. Note that <em>DH1</em> and <em>DH2</em> provide mutual authentication, while <em>DH3</em> and <em>DH4</em> provide forward secrecy.</p><div class="figure"> <img src="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/X3DH.png" alt="DH1...DH4" style="width:50.0%"><p class="caption">DH1...DH4</p></div><p>After calculating <em>SK</em>, Alice deletes her ephemeral private key and the <em>DH</em> outputs.</p><p>Alice then calculates an "associated data" byte sequence <em>AD</em> that contains identity information for both parties:</p><div class="code"><p>&nbsp;&nbsp;&nbsp;&nbsp;AD = Encode(IK<sub>A</sub>) || Encode(IK<sub>B</sub>)</p></div><p>Alice may optionally append additional information to <em>AD</em>, such as Alice and Bob's usernames, certificates, or other identifying information.</p><p>Alice then sends Bob an initial message containing:</p><ul><li>Alice's identity key <em>IK<sub>A</sub></em></li><li>Alice's ephemeral key <em>EK<sub>A</sub></em></li><li>Identifiers stating which of Bob's prekeys Alice used</li><li>An initial ciphertext encrypted with some AEAD encryption scheme <span class="citation">[<a href="#ref-aead">4</a>]</span> using <em>AD</em> as associated data and using an encryption key which is either <em>SK</em> or the output from some cryptographic PRF keyed by <em>SK</em>.</li></ul><p>The
 initial ciphertext is typically the first message in some post-X3DH 
communication protocol. In other words, this ciphertext typically has 
two roles, serving as the first message within some post-X3DH protocol, 
and as part of Alice's X3DH initial message.</p><p>After sending this, Alice may continue using <em>SK</em> or keys derived from <em>SK</em> within the post-X3DH protocol for communication with Bob, subject to the security considerations in <a href="#security-considerations">Section 4</a>.</p><h2 id="receiving-the-initial-message">3.4. Receiving the initial message</h2><p>Upon
 receiving Alice's initial message, Bob retrieves Alice's identity key 
and ephemeral key from the message. Bob also loads his identity private 
key, and the private key(s) corresponding to whichever signed prekey and
 one-time prekey (if any) Alice used.</p><p>Using these keys, Bob repeats the <em>DH</em> and <em>KDF</em> calculations from the previous section to derive <em>SK</em>, and then deletes the <em>DH</em> values.</p><p>Bob then constructs the <em>AD</em> byte sequence using <em>IK<sub>A</sub></em> and <em>IK<sub>B</sub></em>, as described in the previous section. Finally, Bob attempts to decrypt the initial ciphertext using <em>SK</em> and <em>AD</em>. If the initial ciphertext fails to decrypt, then Bob aborts the protocol and deletes <em>SK</em>.</p><p>If
 the initial ciphertext decrypts successfully the protocol is complete 
for Bob. Bob deletes any one-time prekey private key that was used, for 
forward secrecy. Bob may then continue using <em>SK</em> or keys derived from <em>SK</em> within the post-X3DH protocol for communication with Alice, subject to the security considerations in <a href="#security-considerations">Section 4</a>.</p><h1 id="security-considerations">4. Security considerations</h1><h2 id="authentication">4.1. Authentication</h2><p>Before or after an X3DH key agreement, the parties may compare their identity public keys <em>IK<sub>A</sub></em> and <em>IK<sub>B</sub></em>
 through some authenticated channel. For example, they may compare 
public key fingerprints manually, or by scanning a QR code. Methods for 
doing this are outside the scope of this document.</p><p>If authentication is not performed, the parties receive no cryptographic guarantee as to who they are communicating with.</p><h2 id="protocol-replay">4.2. Protocol replay</h2><p>If
 Alice's initial message doesn't use a one-time prekey, it may be 
replayed to Bob and he will accept it. This could cause Bob to think 
Alice had sent him the same message (or messages) repeatedly.</p><p>To 
mitigate this, a post-X3DH protocol may wish to quickly negotiate a new 
encryption key for Alice based on fresh random input from Bob. This is 
the typical behavior of Diffie-Hellman based ratcheting protocols <span class="citation">[<a href="#ref-doubleratchet">5</a>]</span>.</p><p>Bob
 could attempt other mitigations, such as maintaining a blacklist of 
observed messages, or replacing old signed prekeys more rapidly. 
Analyzing these mitigations is beyond the scope of this document.</p><h2 id="replay-and-key-reuse">4.3. Replay and key reuse</h2><p>Another
 consequence of the replays discussed in the previous section is that a 
successfully replayed initial message would cause Bob to derive the same
 <em>SK</em> in different protocol runs.</p><p>For this reason, any 
post-X3DH protocol MUST randomize the encryption key before Bob sends 
encrypted data. For example, Bob could use a DH-based ratcheting 
protocol to combine <em>SK</em> with a freshly generated <em>DH</em> output to get a randomized encryption key <span class="citation">[<a href="#ref-doubleratchet">5</a>]</span>.</p><p>Failure to randomize Bob's encryption key may cause catastrophic key reuse.</p><h2 id="deniability">4.4. Deniability</h2><p>X3DH
 doesn't give either Alice or Bob a publishable cryptographic proof of 
the contents of their communication or the fact that they communicated.</p><p>Like in the OTR protocol <span class="citation">[<a href="#ref-otr">6</a>]</span>,
 in some cases a third party that has compromised legitimate private 
keys from Alice or Bob could be provided a communication transcript that
 appears to be between Alice and Bob and that can only have been created
 by some other party that also has access to legitimate private keys 
from Alice or Bob (i.e. Alice or Bob themselves, or someone else who has
 compromised their private keys).</p><p>If either party is collaborating
 with a third party during protocol execution, they will be able to 
provide proof of their communication to such a third party. This 
limitation on "online" deniability appears to be intrinsic to the 
asynchronous setting <span class="citation">[<a href="#ref-unger">7</a>]</span>.</p><h2 id="signatures">4.5. Signatures</h2><p>It might be tempting to observe that mutual authentication and forward secrecy are achieved by the <em>DH</em>
 calculations, and omit the prekey signature. However, this would allow a
 "weak forward secrecy" attack: A malicious server could provide Alice a
 prekey bundle with forged prekeys, and later compromise Bob's <em>IK<sub>B</sub></em> to calculate <em>SK</em>.</p><p>Alternatively, it might be tempting to replace the DH-based mutual authentication (i.e. <em>DH1</em> and <em>DH2</em>)
 with signatures from the identity keys. However, this reduces 
deniability, increases the size of initial messages, and increases the 
damage done if ephemeral or prekey private keys are compromised, or if 
the signature scheme is broken.</p><h2 id="key-compromise">4.6. Key compromise</h2><p>Compromise
 of a party's private keys has a disastrous effect on security, though 
the use of ephemeral keys and prekeys provides some mitigation.</p><p>Compromise
 of a party's identity private key allows impersonation of that party to
 others. Compromise of a party's prekey private keys may affect the 
security of older or newer <em>SK</em> values, depending on many considerations.</p><p>A
 full analysis of all possible compromise scenarios is outside the scope
 of this document, however a partial analysis of some plausible 
scenarios is below:</p><ul><li><p>If one-time prekeys are used for a 
protocol run then a compromise of Bob's identity key and prekey private 
keys at some future time will not compromise the older <em>SK</em>, assuming the private key for <em>OPK<sub>B</sub></em> was deleted.</p></li><li><p>If one-time prekeys were <em>not</em> used for a protocol run, then a compromise of the private keys for <em>IK<sub>B</sub></em> and <em>SPK<sub>B</sub></em> from that protocol run would compromise the <em>SK</em>
 that was calculated earlier. Frequent replacement of signed prekeys 
mitigates this, as does using a post-X3DH ratcheting protocol which 
rapidly replaces <em>SK</em> with new keys to provide fresh forward secrecy <span class="citation">[<a href="#ref-doubleratchet">5</a>]</span>.</p></li><li><p>Compromise of prekey private keys may enable attacks that extend into the future, such as passive calculation of <em>SK</em>
 values, and impersonation of arbitrary other parties to the compromised
 party ("key-compromise impersonation"). These attacks are possible 
until the compromised party replaces his compromised prekeys on the 
server (in the case of passive attack); or deletes his compromised 
signed prekey's private key (in the case of key-compromise 
impersonation).</p></li></ul><h2 id="server-trust">4.7. Server trust</h2><p>A malicious server could cause communication between Alice and Bob to fail (e.g. by refusing to deliver messages).</p><p>If Alice and Bob authenticate each other as in <a href="#authentication">Section 4.1</a>,
 then the only additional attack available to the server is to refuse to
 hand out one-time prekeys, causing forward secrecy for <em>SK</em> to depend on the signed prekey's lifetime (as analyzed in the previous section).</p><p>This
 reduction in initial forward secrecy could also happen if one party 
maliciously drains another party's one-time prekeys, so the server 
should attempt to prevent this, e.g. with rate limits on fetching prekey
 bundles.</p><h2 id="identity-binding">4.8. Identity binding</h2><p>Authentication as in <a href="#authentication">Section 4.1</a> does not necessarily prevent an "identity misbinding" or "unknown key share" attack.</p><p>This
 results when an attacker ("Charlie") falsely presents Bob's identity 
key fingerprint to Alice as his (Charlie's) own, and then either 
forwards Alice's initial message to Bob, or falsely presents Bob's 
contact information as his own.</p><p>The effect of this is that Alice thinks she is sending an initial message to Charlie when she is actually sending it to Bob.</p><p>To make this more difficult the parties can include more identifying information into <em>AD</em>,
 or hash more identifying information into the fingerprint, such as 
usernames, phone numbers, real names, or other identifying information. 
Charlie would be forced to lie about these additional values, which 
might be difficult.</p><p>However, there is no way to reliably prevent 
Charlie from lying about additional values, and including more identity 
information into the protocol often brings trade-offs in terms of 
privacy, flexibility, and user interface. A detailed analysis of these 
trade-offs is beyond the scope of this document.</p><h1 id="ipr">5. IPR</h1><p>This document is hereby placed in the public domain.</p><h1 id="acknowledgements">6. Acknowledgements</h1><p>The X3DH protocol was developed by Moxie Marlinspike and Trevor Perrin.</p><p>The underlying "Triple DH" key agreement was proposed by Caroline Kudla and Kenny Paterson in <span class="citation">[<a href="#ref-kudla2005">8</a>]</span>, extending the earlier "Double DH" (aka "Protocol 4") key agreement from Simon Blake-Wilson et al <span class="citation">[<a href="#ref-blakewilson1997">9</a>]</span>. Using signatures in combination with implicitly-authenticated key agreement has been discussed in works like <span class="citation">[<a href="#ref-eckpfs">10</a>]</span> and <span class="citation">[<a href="#ref-joint">11</a>]</span>.</p><p>Thanks to Mike Hamburg for discussions about identity binding and elliptic curve public keys.</p><p>Thanks to Nik Unger and Matthew Green for discussions about deniability.</p><p>Thanks to Matthew Green, Tom Ritter, Joseph Bonneau, and Benedikt Schmidt for editorial feedback.</p><h1 id="references" class="unnumbered">7. References</h1><div id="refs" class="references"><div id="ref-rfc7748"><p>[1]
 A. Langley, M. Hamburg, and S. Turner, “Elliptic Curves for Security.” 
Internet Engineering Task Force; RFC 7748 (Informational); IETF, 
Jan-2016. <a href="http://www.ietf.org/rfc/rfc7748.txt" class="uri">http://www.ietf.org/rfc/rfc7748.txt</a></p></div><div id="ref-xeddsa"><p>[2] T. Perrin, “The XEdDSA and VXEdDSA Signature Schemes,” 2016. <a href="https://whispersystems.org/docs/specifications/xeddsa/" class="uri">https://whispersystems.org/docs/specifications/xeddsa/</a></p></div><div id="ref-rfc5869"><p>[3]
 H. Krawczyk and P. Eronen, “HMAC-based Extract-and-Expand Key 
Derivation Function (HKDF).” Internet Engineering Task Force; RFC 5869 
(Informational); IETF, May-2010. <a href="http://www.ietf.org/rfc/rfc5869.txt" class="uri">http://www.ietf.org/rfc/rfc5869.txt</a></p></div><div id="ref-aead"><p>[4]
 P. Rogaway, “Authenticated-encryption with Associated-data,” in 
Proceedings of the 9th ACM Conference on Computer and Communications 
Security, 2002. <a href="http://web.cs.ucdavis.edu/%7Erogaway/papers/ad.pdf" class="uri">http://web.cs.ucdavis.edu/~rogaway/papers/ad.pdf</a></p></div><div id="ref-doubleratchet"><p>[5] T. Perrin, “The Double Ratchet Algorithm (work in progress),” 2016.</p></div><div id="ref-otr"><p>[6]
 N. Borisov, I. Goldberg, and E. Brewer, “Off-the-record Communication, 
or, Why Not to Use PGP,” in Proceedings of the 2004 aCM workshop on 
privacy in the electronic society, 2004. <a href="http://doi.acm.org/10.1145/1029179.1029200" class="uri">http://doi.acm.org/10.1145/1029179.1029200</a></p></div><div id="ref-unger"><p>[7]
 N. Unger and I. Goldberg, “Deniable Key Exchanges for Secure 
Messaging,” in Proceedings of the 22Nd aCM sIGSAC conference on computer
 and communications security, 2015. <a href="http://doi.acm.org/10.1145/2810103.2813616" class="uri">http://doi.acm.org/10.1145/2810103.2813616</a></p></div><div id="ref-kudla2005"><p>[8]
 C. Kudla and K. G. Paterson, “Modular Security Proofs for Key Agreement
 Protocols,” in Advances in Cryptology - ASIACRYPT 2005: 11th 
International Conference on the Theory and Application of Cryptology and
 Information Security, 2005. <a href="http://www.isg.rhul.ac.uk/%7Ekp/ModularProofs.pdf" class="uri">http://www.isg.rhul.ac.uk/~kp/ModularProofs.pdf</a></p></div><div id="ref-blakewilson1997"><p>[9]
 S. Blake-Wilson, D. Johnson, and A. Menezes, “Key agreement protocols 
and their security analysis,” in Crytography and Coding: 6th IMA 
International Conference Cirencester, UK, December 17–19, 1997 
Proceedings, 1997. <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.25.387" class="uri">http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.25.387</a></p></div><div id="ref-eckpfs"><p>[10]
 C. Cremers and M. Feltz, “One-round Strongly Secure Key Exchange with 
Perfect Forward Secrecy and Deniability.” Cryptology ePrint Archive, 
Report 2011/300, 2011. <a href="http://eprint.iacr.org/2011/300" class="uri">http://eprint.iacr.org/2011/300</a></p></div><div id="ref-joint"><p>[11]
 J. P. Degabriele, A. Lehmann, K. G. Paterson, N. P. Smart, and M. 
Strefler, “On the Joint Security of Encryption and Signature in EMV.” 
Cryptology ePrint Archive, Report 2011/615, 2011. <a href="http://eprint.iacr.org/2011/615" class="uri">http://eprint.iacr.org/2011/615</a></p></div></div></div></div><div class="row row-centered"><div class="col-md-3"></div><div class="col-md-6"><h3>Want to get involved with Open Whisper Systems? <a href="https://signal.org/workworkwork/">We're hiring!</a></h3></div><div class="col-md-3"></div></div></div></article></section><footer><div class="container"><div class="row"><div class="col-md-8"> <span class="copyright">Copyright © Open Whisper Systems 2013-2017</span></div><div class="col-md-4"><ul class="list-inline social-buttons"><li> <a href="https://twitter.com/whispersystems"><i class="fa fa-twitter"></i></a></li><li> <a href="https://github.com/whispersystems"><i class="fa fa-github"></i></a></li></ul></div></div></div></footer><script src="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/jquery.js"></script> <script src="Signal%20%3E%3E%20Specifications%20%3E%3E%20The%20X3DH%20Key%20Agreement%20Protocol_files/bootstrap.js"></script> <script type="text/javascript"> var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101071404); (function() { var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//static.getclicky.com/js'; ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s ); })(); </script> <noscript><p><img width="1" height="1" src="//in.getclicky.com/101071404ns.gif" /></noscript>
</body></html>